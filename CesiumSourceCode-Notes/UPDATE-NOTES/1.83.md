Cesium 1.83 å‘å¸ƒæ—¥å¿—

## æ¦‚è§ˆ

**åŠ¨æ€åœ°å½¢å¤¸å¤§**ã€**è¿‡å€¾å…‰çº¿æ—¶é˜´å½±æ¸éšæ•ˆæœ**ã€**å¢åŠ  KTX2 å’Œ  Basis Universal çº¹ç†æ ¼å¼çš„æ”¯æŒ**ã€è‡ªå®šä¹‰é«˜ç¨‹æä¾›å™¨ã€3D-Tiles æ‰©å±•æ£€æŸ¥æœºåˆ¶

æä¾› Windows å¹³å°å¤–è¾¹çº¿æ— æ•ˆçš„æç¤ºæ–‡æ¡£

ä¿®å¤æ—§å¼ tileset é¡¶çº§ç“¦ç‰‡æ— å‡ ä½•è¯¯å·®çš„é”™è¯¯ã€ä¿®å¤ç›¸æœºäº’æ“ä½œé—®é¢˜ã€ä¿®å¤åå¤„ç†å¼‚å¸¸å’Œé—ªå±é—®é¢˜

æ›´æ–°éƒ¨åˆ†æ–‡å­—æ€§æè¿°ï¼ˆæ–‡æ¡£ç±»ï¼‰ 

ç»ˆç»“ IE11 çš„æ”¯æŒï¼š1.83 æ˜¯æœ€åä¸€ä¸ªæ”¯æŒ IE11 çš„ç‰ˆæœ¬ã€‚

## ç ´åå¼æ›´æ–° ğŸ“£

- ä¸å†æ”¯æŒ KTX1 å’Œ Crunch çº¹ç†ï¼›ä½¿ç”¨ [ktx2ktx2](https://github.com/KhronosGroup/KTX-Software) å‡çº§ ktx1 æ–‡ä»¶

## åŠŸèƒ½æ–°å¢ ğŸ‰

- æ–°å¢ **åŠ¨æ€åœ°å½¢å¤¸å¤§åŠŸèƒ½**ï¼Œè§ `Globe.terrainExaggeration` å’Œ `Globe.terrainExaggerationRelativeHeight`ã€‚

  æ­¤æ›´æ–°æ˜¯è‡ª 2015 å¹´ä»¥æ¥çš„å†æ¬¡ä¼˜åŒ–ã€‚å‰è€…æ˜¯å¤¸å¤§çš„å€æ•°ï¼Œåè€…æ˜¯å‘ä¸Šå‘ä¸‹å¤¸å¤§çš„åŸºå‡†é«˜åº¦ã€‚

  åœ°å½¢å¤¸å¤§çš„æ—§ API `Globe.terrainExaggeration` å°†åœ¨ 1.85 ä¸­ç§»é™¤ã€‚

  åŸç†ï¼šå­˜å‚¨æ¯ä¸ªé¡¶ç‚¹çš„ f32 ç±»å‹çš„æµ‹åœ°æ³•çº¿ï¼Œå¹¶åœ¨ç€è‰²å™¨ä¸­å°†å…¶æ·»åŠ åˆ°ç›¸å¯¹ä¸­å¿ƒï¼Œå®ƒçš„æ•ˆæœå³ä½¿ä¸æ˜¯ 64 ä½ä»¿çœŸä¸­ä¹Ÿæ˜¯ä¸é”™çš„ï¼Œå®˜æ–¹æµ‹è¯•ä¸­ä½¿ç”¨ 32 ä½æ³•çº¿ç²¾åº¦æœ€å¤šåªæœ‰ 10 å˜ç±³çš„è¯¯å·®å€¼ã€‚

  ``` glsl
  float newHeight = (height - relativeHeight) * exaggeration + relativeHeight;
  positionRTC += geodeticSurfaceNormal * (newHeight - height);
  // ... ä» positionRTC åæ ‡è½¬ä¸–ç•Œåæ ‡
  ```

  å½“åœ°å½¢å¤¸å¤§æ•°å­—ä¸æ˜¯ 1.0 æ—¶ï¼ˆå“ªæ€•æ˜¯ 1.01ï¼‰æ‰å­˜å‚¨å¤§åœ°è¡¨é¢æ³•çº¿ã€‚æ‰€ä»¥ï¼Œ**è¿™æ˜¯ä¸€ä¸ªæ¶ˆè€—å†…å­˜çš„è¡Œä¸º**ã€‚é™æ€å¤¸å¤§ï¼ˆæ—§APIï¼‰æ˜¯ç±»ä¼¼äºçƒ˜ç„™çš„æ•ˆæœç›´æ¥å†™å…¥å‡ ä½•ä¸­ï¼Œæ‰€ä»¥å†…å­˜æ˜¯ä¸å˜çš„ã€‚åœ¨ `TerrainMesh` ç±»ä¸­ï¼Œå¤§çº¦ä¼šé¢å¤–å ç”¨ 30% çš„å†…å­˜ï¼ˆå¯å‚è€ƒ Chrome å¼€å‘è€…å·¥å…·çš„ å†…å­˜å¿«ç…§ï¼ŒæŸ¥çœ‹å…·ä½“ç±»çš„å†…å­˜å ç”¨ï¼‰ã€‚

  [å‚è€ƒ pr](https://github.com/CesiumGS/cesium/pull/9603)

- æ–°å¢ ShadowMap å‚æ•°ï¼š`options.fadingEnabled` æ¥å½“å…‰æºæ¥è¿‘åœ°å¹³çº¿æ—¶ï¼Œæ§åˆ¶é˜´å½±æ˜¯å¦å…·æœ‰æ·¡å‡ºçš„æ•ˆæœã€‚æ­¤é€‰é¡¹é»˜è®¤å¼€å¯ã€‚

  ![image-20210629025529684](attachments/image-20210629025529684.png)

  ```js
  var shadowMap = viewer.shadowMap;
  shadowMap.maximumDistance = 100000.0; // ç±³ä¸ºå•ä½
  shadowMap.darkness = 0; // æœˆçƒä¸Šæ˜¯é»‘è‰²é˜´å½±
  // !!!
  // æ–° APIï¼Œè¿™ä¸ªå±æ€§é»˜è®¤æ˜¯ trueï¼Œæ­¤å¤„æ˜¾æ€§è®¾ä¸º false
  shadowMap.fadingEnabled = false;
  ```

- æ–°å¢å¯¹ KTX2 å’Œ Basis Universal çº¹ç†æ ¼å¼çš„æ”¯æŒï¼›

  - å¢åŠ å¯¹ glTF æ ¼å¼ä¸­ `KHR_texture_basisu` æ‰©å±•çš„æ”¯æŒ
  - æ·»åŠ äº†å¯¹ 8 ä½ã€16 ä½æµ®ç‚¹å’Œ 32 ä½æµ®ç‚¹çš„ KTX2 é•œé¢åå°„ç¯å¢ƒè´´å›¾çš„æ”¯æŒ
  - åœ¨ `Material` æ¨¡å—ä¸­æ·»åŠ äº†å¯¹ KTX2 å›¾åƒçš„æ”¯æŒ
  - å¯¹æšä¸¾æ¨¡å— `PixelFormat` å’Œ `WebGLConstants` æ·»åŠ äº† `EXT_texture_compression_bptc` å’Œ `WEBGL_compressed_texture_etc`ã€`WEBGL_compressed_texture_astc` æ‰©å±•

  KHR_texture_basisu çº¹ç†æ”¯æŒé 2æ¬¡å¹‚ å°ºå¯¸çš„çº¹ç†è´´å›¾ï¼Œä½†æ˜¯å®˜æ–¹ä»ç„¶å»ºè®®ä½¿ç”¨é•¿å®½å°ºå¯¸ä¸€æ ·çš„ã€ä¸”ä¸º 2æ¬¡å¹‚ çš„çº¹ç†è´´å›¾ã€‚è§ pr [9513](https://github.com/CesiumGS/cesium/pull/9513)

- æ–°å¢è‡ªå®šä¹‰é«˜åº¦å›¾åœ°å½¢æä¾›å™¨ï¼Œå³æ–° API `CustomHeightmapTerrainProvider`ï¼Œä»ä¸€ä¸ªå›è°ƒå‡½æ•°é‡Œè·å–é«˜ç¨‹æ•°æ®ã€‚ä»ä¸‹åˆ—ä¾‹å­ä¸­å¯çœ‹å‡ºï¼Œåªéœ€æŒ‡å®šèƒ½ **è¿”å›é«˜åº¦ç±»å‹æ•°ç»„** çš„å›è°ƒå‡½æ•°ã€å®½åº¦ã€é«˜åº¦ä¸‰ä¸ªå±æ€§å³å¯ã€‚

  ```js
  var width = 32;
  var height = 32;
  
  var viewer = new Cesium.Viewer("cesiumContainer", {
    terrainProvider: new Cesium.CustomHeightmapTerrainProvider({
      callback: function (x, y, level) {
        var buffer = new Float32Array(width * height);
        for (var yy = 0; yy < height; yy++) {
          for (var xx = 0; xx < width; xx++) {
            var v = (y + yy / (height - 1)) / Math.pow(2, level);
            var heightValue = 8000 * (Math.sin(4000 * v) * 0.5 + 0.5);
            var index = yy * width + xx;
            buffer[index] = heightValue;
          }
        }
        return buffer;
      },
      width: width,
      height: height,
    }),
  });
  ```

  æœ‰è¶£çš„æ˜¯ï¼Œè¿™ä¸ªè™½ç„¶å¾ˆçµæ´»ï¼Œä½†æ˜¯å®˜æ–¹ä»ç„¶å»ºè®®ä½¿ç”¨æˆç†Ÿçš„ TerrainProviderï¼Œå› ä¸ºè¿™ä¸ªæ²¡æœ‰æ°´é¢ç‰¹æ•ˆã€‚

- 3dTiles æ‰©å±•æ£€æŸ¥å™¨

  è‹¥ä¸€ä¸ª tileset åœ¨ extensionsRequired æ•°ç»„ä¸­æŒ‡å®šäº†ä¸€ä¸ªéå®˜æ–¹è®°å½•çš„æ‰©å±•ï¼Œä¼šç›´æ¥å¼¹å‡ºè¿è¡Œæ—¶é”™è¯¯ï¼š

  ``` js
  throw new RuntimeError("Unsupported 3D Tiles Extension: " + extension)
  ```

  å‚è€ƒ API `Cesium3DTileset.checkSupportedExtensions(this._extensions)`ï¼Œå®˜æ–¹å‚è€ƒäº† `ModelUtility.js` æ¨¡å—ä¸­å¯¹ glTF çš„æ‰©å±•çš„æ‰©å±•æ£€æŸ¥ã€‚

- ç»ˆäºï¼æ›´æ–°äº†æ–‡æ¡£ï¼šåœ¨ Windows å¹³å°ä¸Šæ‰€æœ‰ä¸»æµæµè§ˆå™¨å°†å¿½ç•¥ `outlineWidth` å±æ€§ï¼ˆåœ¨Windows çš„ WebGL æœ¬èº«ä¸æ”¯æŒå¤–è¾¹çº¿çº¿å®½ç»˜åˆ¶ï¼‰ã€‚æ¶‰åŠåˆ°çš„æ¨¡å—æœ‰ï¼š

  - `BoxGraphics`
  - `CorridorGraphics`
  - `CylinderGraphics`
  - `EllipseGraphics`
  - `EllipsoidGraphics`
  - `PlaneGraphics`
  - `PolygonGraphics`
  - `RectangleGraphics`
  - `WallGraphics`
  - `PolylineVolumeGraphics`

  å±Šæ—¶å¯ä»¥æŸ¥çœ‹æœ€æ–°çš„å¸®åŠ©æ–‡æ¡£ã€‚

- ä¸º `KmlTour`, `KmlTourFlyTo`, å’Œ `KmlTourWait` æ¨¡å—å¢åŠ äº†æ–‡æ¡£ã€‚ä¸º `KmlDataSource` æ¨¡å—çš„ `kmlTours` è¯»ç±»å‹å±æ€§æ·»åŠ æ–‡æ¡£ï¼Œå¹¶ä» `KmlTourSoundCues` ç±»ä¸­ç§»é™¤æ–‡æ¡£å¼•ç”¨ã€‚

- å¯¹ OSM Buildings ä»¥åŠå…¶ä»–åœ¨ glTF æ¨¡å‹ä¸­ç”¨åˆ°äº† `CESIUM_primitive_outline` æ‰©å±•çš„ tileset æä¾›éšè—è¾¹çº¿çš„èƒ½åŠ›ã€‚

  ä¸»è¦æ˜¯åœ¨ `Model.js`ã€`Batched3DModel3DTileContent.js`ã€`Cesium3DTileset.js`ã€`Gltf3DTileContent.js`ã€`Instanced3DModel3DTileContent.js`ã€`ModelInstanceCollection.js`ã€`createOsmBuildings.js`ã€`ModelSpec.js` ä½œå‡ºäº†ä¿®æ”¹ï¼Œéƒ¨åˆ†æ¨¡å—åŠ å…¥ `showOutline` å±æ€§ã€‚ ï¼ˆ[å‚è€ƒ pr](https://github.com/CesiumGS/cesium/pull/9629)ï¼‰

- å¯¹äº glTF æŸäº›ç‰¹å®šçš„çº¹ç†å’Œ `ImageBitmap` çš„è‰²å½©ç©ºé—´ï¼Œæä¾›äº† `ignore` é€‰é¡¹ã€‚

  

## ä¿®å¤ğŸ”§

- ä¿®å¤äº†ä¸€äº›æ—§å¼ tileset ä¸­é¡¶çº§ç“¦ç‰‡å› ä¸ºæ²¡æœ‰å‡ ä½•è¯¯å·®è€Œä¸åŠ è½½çš„é”™è¯¯

  ä»¥å¾€æœ‰ä¸€äº› 3dtiles çš„æ ¹å±æ€§ä¸­æ²¡æœ‰ `geometricError`ï¼Œä¼šå¯¼è‡´ `preprocess3DTileContent.js` æ¨¡å—åˆ¤æ–­é”™è¯¯ã€‚åœ¨ 1.83 ä¸­å·²ä¿®å¤ä¸ºåˆ¤æ–­ `root` å±æ€§ã€‚

  ![image-20210629154356449](attachments/image-20210629154356449.png)

- ä¿®å¤äº† `WebMapTileServiceImageryProvider` è¿™ä¸ªæ¨¡å—ä¸­è‹¥ URL ä½¿ç”¨äº†å­åŸŸï¼ˆSubDomainsï¼‰åï¼Œè¯·æ±‚ä¼šå› ä¸ºæŸ¥è¯¢å‚æ•°è€Œå¤±è´¥çš„æƒ…å†µï¼ˆè¯¦ç»†é—®é¢˜è§ï¼š[9598](https://github.com/CesiumGS/cesium/issues/9598)ï¼‰

- ä¿®å¤äº† `ScreenSpaceCameraController.tilt3DOnTerain` API ä¸­å½“æ‘‡æ™ƒç›¸æœºè§†è§’æ—¶ï¼Œä¼šæœ‰åç§»çš„å°é—®é¢˜ã€‚ç²¾å½©æ¨ç†è§ï¼š[9562](https://github.com/CesiumGS/cesium/pull/9562) ä¼¼ä¹æ˜¯å›½äºº

- å½“åœ°çƒè¡¨é¢ç“¦ç‰‡ï¼ˆGlobeSurfaceTileæ¨¡å—ï¼‰è¯·æ±‚é”™è¯¯æ—¶ï¼Œä¿®å¤åœ¨æ§åˆ¶å°ä¸­çš„æŠ¥é”™

- ä¿®å¤äº†æ²™ç›’ç¤ºä¾‹ä¸­ KML ç¤ºä¾‹çš„ç¼©ç•¥å›¾ä¸¢å¤±

- ä¿®å¤äº† `GlobeFS` ç€è‰²å™¨ä¸­å½“è‡ªå®šä¹‰æè´¨çš„ `positionToEyeEC` å’Œ `tangentToEyeMatrix` å±æ€§æœªè®¾ç½®çš„é”™è¯¯

  ``` glsl
  // GlobeFS.glsl
  void main() {
    // å…¶ä»–éƒ¨åˆ†ç•¥
    materialInput.positionToEyeEC = -v_positionEC;
    materialInput.tangentToEyeMatrix = czm_eastNorthUpToEyeCoordinates(v_positionMC, normalize(v_normalEC));  
  }
  ```

- ä¿®å¤äº† `Matrix4` æ¨¡å—ä¸­ `inverse` å’Œ `inverseTransformation` ä¸­ä½¿ç”¨ ä»¿å°„å˜æ¢ çš„è¯¯å¯¼æ€§æ–‡æ¡£ï¼Œå·²ä½¿ç”¨æ—‹è½¬å’Œå¹³ç§»æ›¿ä»£ã€‚

- å½“ glTF æ¨¡å‹å¼•ç”¨äº†å¤–éƒ¨å›¾åƒèµ„æºä¸”æ²¡æœ‰è¢« `preferImageBitmap` åŠ è½½æ—¶ï¼Œå®ƒä¼šåœ¨ä¸»çº¿ç¨‹çš„è§£ç è¿‡ç¨‹ä¸­é€ æˆå¸§ç‡æš´è·Œçš„é—®é¢˜ï¼Œå·²ç»ä¿®å¤ï¼›é€šå¸¸ glTF çš„å›¾åƒèµ„æºéƒ½æ˜¯å†…åµŒçš„ï¼Œä¹Ÿå°±æ˜¯ glb çš„å½¢å¼ï¼Œè¿™ä¸ªé—®é¢˜è¢«å®˜æ–¹å‘ç°å¹¶ä¿®å¤ã€‚é’ˆå¯¹çš„æ¨¡å—ï¼š`Scene/GltfImageLoader.js` å’Œ `Scene/Model.js`

- ä¿®å¤ `Cesium3DTileStyle` ä¸­å…³äºé¢œè‰²ã€æ˜¾éšçš„è¯¯å¯¼æ€§ `else` æ¡ä»¶è®¾ç½®ã€‚é€»è¾‘ä¸Šï¼Œå¦‚æœæ²¡æœ‰ç»™å®šï¼Œé‚£å°±åº”è¯¥ä½¿ç”¨é»˜è®¤å€¼ trueã€‚ä¸»è¦é’ˆå¯¹çš„æ¨¡å—ï¼š`Scene/Cesium3DTileBatchTable.js`

- ä¿®å¤åå¤„ç†ç¦ç”¨åå†å¯ç”¨æ—¶å‘ç”Ÿå´©æºƒçš„é—®é¢˜ï¼Œè¿™ä¸ªä¿®å¤åŒæ—¶èƒ½é˜²æ­¢åœ¨ç¬¬ä¸€æ¬¡å¯ç”¨åå¤„ç†é˜¶æ®µåŠŸèƒ½æ—¶é—ªå±çš„é—®é¢˜ã€‚åŸå› ä¼¼ä¹æ˜¯å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ä¸ªåå¤„ç†é˜¶æ®µè¢«æ ‡è®°ä¸ºæ´»åŠ¨çš„è¯ï¼Œç¼“å­˜çš„çº¹ç†å°±ä¸ä¼šåˆ›å»º FBOï¼Œè™½ç„¶è¿™äº›åå¤„ç†éƒ½å¯ç”¨äº†ã€‚é’ˆå¯¹æ¨¡å—ï¼š`PostProcessStageCollection.js`



## åŠŸèƒ½åºŸå¼ƒâ³

-  `CesiumWidget`, `Viewer`, åŠ `Scene` æ¨¡å—çš„ `Scene.terrainExaggeration`ã€`options.terrainExaggeration` å°†ä¼šåœ¨ 1.85 ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚ ä½¿ç”¨ `Globe.terrainExaggeration` API æ¥ä»£æ›¿ä»–ä»¬ã€‚
- `loadCRN` å’Œ `loadKTX` å‡½æ•°è¢«ç§»é™¤ã€‚
- å¯¹ IE11 çš„æ”¯æŒå°†åœ¨ 1.84 æ­£å¼åœæ­¢